<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HR Intel | AI Recruitment System</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
    --primary: #00f5d4;
    --secondary: #9b5de5;
    --bg-dark: #0f172a;
    --sidebar-width: 260px;
    --card-bg: rgba(30, 41, 59, 0.7);
}

body {
    font-family: 'Inter', system-ui;
    background: var(--bg-dark);
    color: #f8fafc;
    margin: 0;
    display: flex;
}

.sidebar {
    width: var(--sidebar-width);
    background: #1e293b;
    height: 100vh;
    position: fixed;
    display: flex;
    flex-direction: column;
}

.sidebar-header {
    padding: 25px;
    font-size: 1.4rem;
    font-weight: bold;
    color: var(--primary);
}

.nav-item {
    padding: 15px 25px;
    cursor: pointer;
    color: #94a3b8;
}

.nav-item:hover {
    background: rgba(255,255,255,0.05);
    color: white;
}

.nav-item.active {
    color: var(--primary);
    border-right: 4px solid var(--primary);
}

.main-content {
    margin-left: var(--sidebar-width);
    padding: 40px;
    width: 100%;
}

.view-section { display: none; }
.view-section.active { display: block; }

.container {
    background: var(--card-bg);
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 25px;
}

.grid-3 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px,1fr));
    gap: 20px;
}

.stat-box {
    background: rgba(0,0,0,0.3);
    padding: 20px;
    border-radius: 10px;
    text-align: center;
}

.stat-box h2 {
    color: var(--primary);
}

input, select, button {
    padding: 12px;
    border-radius: 8px;
    border: none;
}

button {
    background: var(--primary);
    font-weight: bold;
    cursor: pointer;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 12px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.loading {
    color: var(--primary);
    font-weight: bold;
}
</style>
</head>

<body>

<nav class="sidebar">
    <div class="sidebar-header">HR Intel</div>
    <div class="nav-item active" onclick="showView('uploadView', this)">üìÅ Upload</div>
    <div class="nav-item" onclick="showView('statsView', this)">üìä Analytics</div>
    <div class="nav-item" onclick="showView('tableView', this)">üë• Candidates</div>
    <div class="nav-item" onclick="showView('aiView', this)">ü§ñ AI Recruiter</div>
</nav>

<main class="main-content">

<section id="uploadView" class="view-section active">
    <h1>Upload Candidate CSV</h1>
    <div class="container">
        <input type="file" id="csvFile" accept=".csv">
        <button onclick="loadCSV()">Process</button>
    </div>
</section>

<section id="statsView" class="view-section">
    <h1>Analytics Dashboard</h1>

    <div class="grid-3">
        <div class="stat-box">
            <h4>Total Candidates</h4>
            <h2 id="totalCount">0</h2>
        </div>
        <div class="stat-box">
            <h4>Avg Experience</h4>
            <h2 id="avgExp">0</h2>
        </div>
    </div>

    <div class="container">
        <canvas id="skillChart"></canvas>
    </div>
</section>

<section id="tableView" class="view-section">
    <h1>Candidate Database</h1>
    <div class="container">
        <table id="dataTable"></table>
    </div>
</section>

<section id="aiView" class="view-section">
    <h1>AI Powered Recruitment</h1>

    <div class="container">
        <input type="text" id="roleInput" placeholder="Enter Job Role (e.g. Machine Learning Engineer)" style="width:70%">
        <button onclick="runAIRecruiter()">Find Best Candidates</button>
        <p id="loadingText" class="loading"></p>
    </div>

    <div class="container">
        <table id="aiResultsTable"></table>
    </div>
</section>

</main>

<script>
let originalData = [];
let charts = {};

function showView(id, element) {
    if(originalData.length === 0 && id !== 'uploadView'){
        alert("Upload CSV first");
        return;
    }

    document.querySelectorAll('.view-section').forEach(v=>v.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(v=>v.classList.remove('active'));

    document.getElementById(id).classList.add('active');
    element.classList.add('active');
}

function loadCSV(){
    const file = document.getElementById("csvFile").files[0];
    if(!file) return alert("Select CSV file");

    Papa.parse(file,{
        header:true,
        dynamicTyping:true,
        complete:(results)=>{
            originalData = results.data;
            updateDashboard();
            alert("Data Loaded Successfully");
        }
    });
}

function updateDashboard(){
    document.getElementById("totalCount").innerText = originalData.length;

    const totalExp = originalData.reduce((a,b)=>a+(b.Experience||0),0);
    document.getElementById("avgExp").innerText =
        (totalExp/(originalData.length||1)).toFixed(1);

    const table = document.getElementById("dataTable");
    if(originalData.length > 0){
        const headers = Object.keys(originalData[0]);
        table.innerHTML = `<tr>${headers.map(h=>`<th>${h}</th>`).join("")}</tr>`;
        table.innerHTML += originalData.map(r=>
            `<tr>${headers.map(h=>`<td>${r[h]||''}</td>`).join("")}</tr>`
        ).join("");
    }

    const skillMap = {};
    originalData.forEach(r=>{
        r.Skills?.split(",").forEach(s=>{
            const skill = s.trim();
            skillMap[skill] = (skillMap[skill]||0)+1;
        });
    });

    if(charts.skill) charts.skill.destroy();

    charts.skill = new Chart(document.getElementById("skillChart"),{
        type:'bar',
        data:{
            labels:Object.keys(skillMap),
            datasets:[{
                label:'Skill Count',
                data:Object.values(skillMap),
                backgroundColor:'#00f5d4'
            }]
        },
        options:{plugins:{legend:{labels:{color:"#fff"}}}}
    });
}

/* REAL ML BACKEND CALL */
async function runAIRecruiter(){

    const role = document.getElementById("roleInput").value.trim();
    if(!role) return alert("Enter job role");

    document.getElementById("loadingText").innerText = "Running AI Matching...";

    try{
        const response = await fetch("https://salary-predictor-backend-lv48.onrender.com",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
                role:role,
                candidates:originalData
            })
        });

        const results = await response.json();
        displayAIResults(results);

        document.getElementById("loadingText").innerText = "";
    }
    catch(err){
        document.getElementById("loadingText").innerText = "";
        alert("Backend not running. Start FastAPI server.");
    }
}

function displayAIResults(results){
    const table = document.getElementById("aiResultsTable");

    if(results.length === 0){
        table.innerHTML = "<tr><td>No matches found</td></tr>";
        return;
    }

    const headers = Object.keys(results[0]);

    table.innerHTML = `<tr>${headers.map(h=>`<th>${h}</th>`).join("")}</tr>`;
    table.innerHTML += results.map(r=>
        `<tr>${headers.map(h=>`<td>${r[h]}</td>`).join("")}</tr>`
    ).join("");
}
</script>

</body>

</html>
